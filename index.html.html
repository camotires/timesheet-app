<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Weekly Timesheet App</title>
<style>
  body {font-family: Arial, sans-serif; margin:0; padding:0; background:#071029; color:#e6eef6; display:flex; justify-content:center; align-items:center; height:100vh;}
  button {padding:15px 25px; font-size:1.2rem; margin:10px; border:none; border-radius:10px; cursor:pointer;}
  .center {text-align:center;}
  .week-btn {width:140px; display:flex; flex-direction:column; align-items:center; justify-content:center; background:#0ea5a4; color:#042022;}
  .grid {display:grid; grid-template-columns: repeat(5, 1fr); gap:10px; margin-top:20px;}
  .day-btn {padding:20px; background:#0ea5a4; color:#042022; border-radius:8px; cursor:pointer; display:flex; flex-direction:column; justify-content:center; align-items:center;}
  .form-container {position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); display:flex; justify-content:center; align-items:center; z-index:100;}
  .form {background:#07182a; padding:20px; border-radius:12px; width:90%; max-width:500px; display:flex; flex-direction:column; gap:10px;}
  input, select {padding:8px; border-radius:6px; border:none; width:100%;}
  #sigPad {border:1px dashed rgba(255,255,255,0.3); height:120px; border-radius:6px;}
  .controls {display:flex; justify-content:space-between; margin-top:10px;}
</style>
</head>
<body>
<div id="app" class="center">
  <button id="createTimesheet">Create Timesheet</button>
</div>

<div id="formOverlay" class="form-container" style="display:none">
  <div class="form">
    <label>Date</label><input type="date" id="date" />
    <label>Address</label><input type="text" id="address" />
    <label>Type of Job</label><input type="text" id="jobType" />
    <label>Hours billed to customer</label><input type="number" step="0.25" id="hoursCustomer" />
    <label>Hours billed to CGYAIR</label><input type="number" step="0.25" id="hoursCg" />
    <label>Payment Method</label>
    <select id="paymentMethod">
      <option>Cash</option>
      <option>Debit</option>
      <option>Credit</option>
      <option>Cheque</option>
      <option>PO</option>
    </select>
    <label>Billing Sent</label>
    <select id="billingSent">
      <option>No</option>
      <option>Yes</option>
    </select>
    <label>Signature</label>
    <canvas id="sigPad"></canvas>
    <div class="controls">
      <button id="backBtn">Back</button>
      <button id="saveDay">Save</button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
let currentWeek = null;
let currentDay = null;
const app = document.getElementById('app');
const overlay = document.getElementById('formOverlay');
const sigCanvas = document.getElementById('sigPad');
const sigPad = new SignaturePad(sigCanvas,{backgroundColor:'rgba(255,255,255,0)'});

let timesheets = JSON.parse(localStorage.getItem('weeklyTimesheets') || '{}');
const days = ['Monday','Tuesday','Wednesday','Thursday','Friday'];
function saveStorage(){localStorage.setItem('weeklyTimesheets',JSON.stringify(timesheets));}
function showStart(){app.innerHTML='<button id="createTimesheet">Create Timesheet</button>';document.getElementById('createTimesheet').onclick=showWeeks;}
function showWeeks(){
  const totalWeek1 = totalHours('week1');
  const totalWeek2 = totalHours('week2');
  app.innerHTML=`<div class="center">
    <div>Total Hours Combined: ${totalWeek1+totalWeek2}</div>
    <button class="week-btn" id="week1Btn">Week 1\n(${totalWeek1} hrs)</button>
    <button class="week-btn" id="week2Btn">Week 2\n(${totalWeek2} hrs)</button>
  </div>`;
  document.getElementById('week1Btn').onclick=()=>showGrid('week1');
  document.getElementById('week2Btn').onclick=()=>showGrid('week2');
}
function showGrid(week){
  currentWeek = week;
  let gridHTML = '<div class="grid">';
  for(const d of days){
    const dayHours = timesheets[week]&&timesheets[week][d]? timesheets[week][d].hoursCustomer+timesheets[week][d].hoursCg:0;
    gridHTML+=`<div class="day-btn" data-day="${d}">${d}\n(${dayHours} hrs)</div>`;
  }
  gridHTML+='</div><div class="center"><button id="exportPdf">Export PDF</button><button id="backWeeks">Back</button></div>';
  app.innerHTML=gridHTML;
  document.querySelectorAll('.day-btn').forEach(b=>b.onclick=()=>editDay(b.dataset.day));
  document.getElementById('exportPdf').onclick=()=>exportPDF(currentWeek);
  document.getElementById('backWeeks').onclick=showWeeks;
}
function editDay(day){
  currentDay = day;
  overlay.style.display='flex';
  const entry = timesheets[currentWeek]&&timesheets[currentWeek][day]?timesheets[currentWeek][day]:{};
  document.getElementById('date').value = entry.date || '';
  document.getElementById('address').value = entry.address || '';
  document.getElementById('jobType').value = entry.jobType || '';
  document.getElementById('hoursCustomer').value = entry.hoursCustomer || '';
  document.getElementById('hoursCg').value = entry.hoursCg || '';
  document.getElementById('paymentMethod').value = entry.paymentMethod || 'Cash';
  document.getElementById('billingSent').value = entry.billingSent || 'No';
  sigPad.clear();
  if(entry.signature){const img=new Image();img.src=entry.signature;img.onload=()=>{sigPad.clear();sigCanvas.getContext('2d').drawImage(img,0,0,sigCanvas.width,sigCanvas.height);}};
}
document.getElementById('backBtn').onclick=()=>{overlay.style.display='none';};
document.getElementById('saveDay').onclick=()=>{
  if(!timesheets[currentWeek]) timesheets[currentWeek]={};
  timesheets[currentWeek][currentDay]={
    date:document.getElementById('date').value,
    address:document.getElementById('address').value,
    jobType:document.getElementById('jobType').value,
    hoursCustomer:parseFloat(document.getElementById('hoursCustomer').value)||0,
    hoursCg:parseFloat(document.getElementById('hoursCg').value)||0,
    paymentMethod:document.getElementById('paymentMethod').value,
    billingSent:document.getElementById('billingSent').value,
    signature:sigPad.isEmpty()?null:sigPad.toDataURL('image/png')
  };
  saveStorage();
  overlay.style.display='none';
  showGrid(currentWeek);
};
function totalHours(week){
  if(!timesheets[week]) return 0;
  return Object.values(timesheets[week]).reduce((acc,e)=>acc+(e.hoursCustomer||0)+(e.hoursCg||0),0);
}
async function exportPDF(week){
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF();
  let y=10;
  const weekEntries = timesheets[week]||{};
  for(const d of days){
    const e = weekEntries[d];
    if(e){
      pdf.setFontSize(12);
      pdf.text(`${d}: ${e.date}`,10,y); y+=6;
      pdf.text(`Address: ${e.address}`,10,y); y+=6;
      pdf.text(`Job Type: ${e.jobType}`,10,y); y+=6;
      pdf.text(`Hours Customer: ${e.hoursCustomer}`,10,y); y+=6;
      pdf.text(`Hours CGYAIR: ${e.hoursCg}`,10,y); y+=6;
      pdf.text(`Payment Method: ${e.paymentMethod}`,10,y); y+=6;
      pdf.text(`Billing Sent: ${e.billingSent}`,10,y); y+=6;
      if(e.signature){
        const imgProps = pdf.getImageProperties(e.signature);
        pdf.addImage(e.signature,'PNG',10,y,100,60); y+=65;
      }
      y+=4;
    }
  }
  pdf.setFontSize(14);
  pdf.text(`Total hours ${week}: ${totalHours(week)}`,10,y); y+=10;
  pdf.text(`Combined Total Hours: ${totalHours('week1')+totalHours('week2')}`,10,y);
  pdf.save(`${week}_timesheet.pdf`);
}
showStart();
</script>
</body>
</html>
