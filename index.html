<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#0ea5a4" />
  <title>Timesheet Logger — Upgraded Web App</title>
  <style>
    :root{--accent:#0ea5a4;--bg:#071029;--card:#07182a;--muted:#94a3b8}
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter, Roboto, system-ui, -apple-system, sans-serif;background:linear-gradient(180deg,#071029,#021125);color:#e6eef6}
    .app{max-width:1050px;margin:18px auto;padding:18px}
    header{display:flex;align-items:center;gap:12px}
    .logo{width:56px;height:56px;border-radius:12px;background:var(--accent);display:flex;align-items:center;justify-content:center;font-weight:700;color:#042022}
    h1{margin:0;font-size:1.2rem}
    .grid{display:grid;grid-template-columns:420px 1fr;gap:16px;margin-top:14px}
    .card{background:rgba(255,255,255,0.03);padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,0.02)}

    label{display:block;font-size:0.85rem;margin-bottom:6px;color:var(--muted)}
    input[type=text], input[type=date], input[type=number], select{width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit}
    .row{display:flex;gap:8px}
    .controls{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
    button{background:var(--accent);color:#042022;padding:8px 12px;border-radius:10px;border:0;cursor:pointer;font-weight:600}
    .ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted)}
    .list{max-height:70vh;overflow:auto;padding:8px}
    .month{margin-bottom:12px}
    .month h3{margin:6px 0 8px 0;font-size:0.95rem}
    .entry{display:flex;align-items:center;justify-content:space-between;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.02);margin-bottom:6px}
    .entry .meta{font-size:0.85rem;color:var(--muted)}
    .right{display:flex;gap:8px}
    .signature-pad{border:1px dashed rgba(255,255,255,0.06);height:120px;border-radius:8px}
    @media(max-width:980px){.grid{grid-template-columns:1fr}.logo{width:48px;height:48px}}
    #printArea{width:800px;padding:20px;background:white;color:#042022;border-radius:6px}
    #printArea h2{margin:0 0 8px 0}
    #printArea .row{display:flex;justify-content:space-between}
    #printArea .sigimg{border-top:1px solid #ccc;padding-top:6px;margin-top:8px}
  </style>
</head>
<body>
<div class="app">
<header>
  <div class="logo">T</div>
  <div>
    <h1>Timesheet Logger Upgraded</h1>
    <div style="color:var(--muted);font-size:0.9rem">Add up to 2 entries per month, edit, CSV export/import, combined monthly PDF, signature, and backup.</div>
  </div>
</header>
<div class="grid">
<section class="card">
  <strong>New / Edit Entry</strong>
  <div style="margin-top:8px">
    <label>Date</label>
    <input id="date" type="date" />
    <label>Address</label>
    <input id="address" type="text" />
    <label>Type of job</label>
    <input id="jobType" type="text" />
    <div class="row" style="margin-top:8px">
      <div style="flex:1">
        <label>Hours billed to customer</label>
        <input id="hoursCustomer" type="number" min="0" step="0.25" />
      </div>
      <div style="width:140px">
        <label>Hours billed to CGYAIR</label>
        <input id="hoursCg" type="number" min="0" step="0.25" />
      </div>
    </div>
    <label>Payment method</label>
    <select id="payment">
      <option value="">-- select --</option>
      <option>Cash</option>
      <option>Debit</option>
      <option>Credit</option>
      <option>Cheque</option>
      <option>PO</option>
    </select>
    <label>Billing sent</label>
    <select id="billingSent">
      <option>No</option>
      <option>Yes</option>
    </select>
    <label>Signature</label>
    <canvas id="sigPad" class="signature-pad" width="400" height="120"></canvas>
    <div class="controls">
      <button id="clearSig" type="button" class="ghost">Clear Signature</button>
      <button id="saveEntry">Save Entry</button>
    </div>
    <div style="margin-top:8px" class="controls">
      <button id="backupJson" class="ghost">Backup JSON</button>
      <input type="file" id="importJson" accept="application/json" class="ghost" style="padding:6px" />
      <button id="exportCsv" class="ghost">Export CSV</button>
    </div>
  </div>
</section>
<section class="card">
  <strong>Saved entries</strong>
  <div class="list" id="monthsList" aria-live="polite"></div>
</section>
</div>
<div id="printWrapper" style="position:fixed;left:-9999px;top:-9999px;"><div id="printArea"></div></div>
</div>
<script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
const STORAGE_KEY='timesheet_logger_v2';
const dateEl=document.getElementById('date');
const addressEl=document.getElementById('address');
const jobEl=document.getElementById('jobType');
const hoursCustomerEl=document.getElementById('hoursCustomer');
const hoursCgEl=document.getElementById('hoursCg');
const paymentEl=document.getElementById('payment');
const billingSentEl=document.getElementById('billingSent');
const sigCanvas=document.getElementById('sigPad');
const clearSigBtn=document.getElementById('clearSig');
const saveBtn=document.getElementById('saveEntry');
const monthsList=document.getElementById('monthsList');
const backupBtn=document.getElementById('backupJson');
const importJsonEl=document.getElementById('importJson');
const exportCsvBtn=document.getElementById('exportCsv');

const signaturePad=new SignaturePad(sigCanvas,{backgroundColor:'rgba(255,255,255,0)',penColor:'black'});
let entries=[];
let editId=null;

function load(){try{entries=JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]')}catch(e){entries=[]}renderMonths();}
function persist(){localStorage.setItem(STORAGE_KEY,JSON.stringify(entries));}
function monthKeyFromDate(d){const dt=new Date(d);return dt.getFullYear()+'-'+String(dt.getMonth()+1).padStart(2,'0');}
function formatMonthLabel(ym){const [y,m]=ym.split('-');const date=new Date(y,parseInt(m)-1,1);return date.toLocaleString(undefined,{month:'long',year:'numeric'});}
function addEntry(){
  const d=dateEl.value||new Date().toISOString().slice(0,10);
  const addr=addressEl.value.trim();
  const job=jobEl.value.trim();
  const hc=parseFloat(hoursCustomerEl.value)||0;
  const hg=parseFloat(hoursCgEl.value)||0;
  const payment=paymentEl.value||'';
  const billing=billingSentEl.value||'No';
  const sigData=signaturePad.isEmpty()?null:signaturePad.toDataURL('image/png');
  const key=monthKeyFromDate(d);
  const monthEntries=entries.filter(e=>e.monthKey===key);
  if(!editId && monthEntries.length>=2){alert('Only 2 entries are allowed per month');return;}
  const title=monthEntries.length===0?'Week1':'Week2';
  const entry={id:editId||Date.now().toString(),date:d,address:addr,jobType:job,hoursCustomer:hc,hoursCg:hg,paymentMethod:payment,billingSent:billing,signature:sigData,monthKey:key,title:title,createdAt:new Date().toISOString()};
  if(editId){entries=entries.map(e=>e.id===editId?entry:e);editId=null;}else{entries.push(entry);}
  persist();clearForm();renderMonths();}
function clearForm(){dateEl.value='';addressEl.value='';jobEl.value='';hoursCustomerEl.value='';hoursCgEl.value='';paymentEl.value='';billingSentEl.value='No';signaturePad.clear();editId=null;}
function deleteEntry(id){if(!confirm('Delete entry?'))return;entries=entries.filter(e=>e.id!==id);persist();renderMonths();}
function editEntry(id){const e=entries.find(x=>x.id===id);if(!e)return;editId=id;dateEl.value=e.date;addressEl.value=e.address;jobEl.value=e.jobType;hoursCustomerEl.value=e.hoursCustomer;hoursCgEl.value=e.hoursCg;paymentEl.value=e.paymentMethod;billingSentEl.value=e.billingSent;if(e.signature){const img=new Image();img.src=e.signature;img.onload=()=>{signaturePad.clear();const ctx=sigCanvas.getContext('2d');ctx.drawImage(img,0,0,sigCanvas.width,sigCanvas.height);};}else{signaturePad.clear();}}
function renderMonths(){monthsList.innerHTML='';const grouped={};entries.forEach(e=>{grouped[e.monthKey]=grouped[e.monthKey]||[];grouped[e.monthKey].push(e)});const keys=Object.keys(grouped).sort((a,b)=>b.localeCompare(a));if(keys.length===0){monthsList.innerHTML='<div style="color:var(--muted)">No entries yet</div>';return;}
keys.forEach(k=>{
  const div=document.createElement('div');div.className='month';
  const h3=document.createElement('h3');h3.textContent=formatMonthLabel(k);div.appendChild(h3);
  const list=grouped[k].sort((a,b)=>a.createdAt.localeCompare(b.createdAt));
  list.forEach(e=>{
    const item=document.createElement('div');item.className='entry';
    const left=document.createElement('div');left.innerHTML=`<div style="font-weight:700">${e.title}</div><div class=\"meta\">${e.date} • ${e.jobType} • ${e.address}</div>`;
    const right=document.createElement('div');right.className='right';
    const editBtn=document.createElement('button');editBtn.textContent='Edit';editBtn.className='ghost';editBtn.onclick=()=>editEntry(e.id);
    const pdfBtn=document.createElement('button');pdfBtn.textContent='PDF';pdfBtn.className='ghost';pdfBtn.onclick=()=>generatePdfForEntry(e.id);
    right.appendChild(editBtn);right.appendChild(pdfBtn);
    item.appendChild(left);item.appendChild(right);div.appendChild(item);
  });
  const monthPdfBtn=document.createElement('button');monthPdfBtn.textContent='Export Month PDF';monthPdfBtn.className='ghost';monthPdfBtn.onclick=()=>generatePdfForMonth(k);
  div.appendChild(monthPdfBtn);monthsList.appendChild(div);
});}
function escapeHtml(str){if(!str)return'';return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}
function buildPrintArea(entryList){let html='';entryList.forEach(entry=>{const total=(parseFloat(entry.hoursCustomer)||0)+(parseFloat(entry.hoursCg)||0);html+=`<div style="margin-bottom:20px"><h2>${entry.title}</h2><div><strong>Date:</strong> ${entry.date}</div><div><strong>Address:</strong> ${escapeHtml(entry.address)}</div><div><strong>Job Type:</strong> ${escapeHtml(entry.jobType)}</div><div><strong>Hours to Customer:</strong> ${entry.hoursCustomer}</div><div><strong>Hours to CGYAIR:</strong> ${entry.hoursCg}</div><div><strong>Total Hours:</strong> ${total}</div><div><strong>Payment:</strong> ${escapeHtml(entry.paymentMethod)}</div><div><strong>Billing Sent:</strong> ${escapeHtml(entry.billingSent)}</div>${entry.signature?`<div class="sigimg"><img src="${entry.signature}" style="max-width:300px;max-height:120px"/></div>`:'<div style="color:#666">(no signature)</div>'}</div>`});document.getElementById('printArea').innerHTML=html;}
async function generatePdfForEntry(id){const entry=entries.find(e=>e.id===id);if(!entry)return;buildPrintArea([entry]);const el=document.getElementById('printArea');const canvas=await html2canvas(el,{scale:2});const imgData=canvas.toDataURL('image/png');const { jsPDF }=window.jspdf;const pdf=new jsPDF({orientation:'portrait',unit:'pt',format:[canvas.width,canvas.height]});pdf.addImage(imgData,'PNG',0,0,canvas.width,canvas.height);pdf.save(entry.title+' - '+entry.date+'.pdf');}
async function generatePdfForMonth(monthKey){const monthEntries=entries.filter(e=>e.monthKey===monthKey);if(monthEntries.length===0)return;buildPrintArea(monthEntries);const el=document.getElementById('printArea');const canvas=await html2canvas(el,{scale:2});const imgData=canvas.toDataURL('image/png');const { jsPDF }=window.jspdf;const pdf=new jsPDF({orientation:'portrait',unit:'pt',format:[canvas.width,canvas.height]});pdf.addImage(imgData,'PNG',0,0,canvas.width,canvas.height);pdf.save(formatMonthLabel(monthKey)+'.pdf');}
function backupJson(){const data=new Blob([JSON.stringify(entries,null,
